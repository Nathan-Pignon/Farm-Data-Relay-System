\doxysection{fdrs\+\_\+node.\+h}
\hypertarget{fdrs__node_8h_source}{}\label{fdrs__node_8h_source}\index{src/fdrs\_node.h@{src/fdrs\_node.h}}
\mbox{\hyperlink{fdrs__node_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ \ FARM\ DATA\ RELAY\ SYSTEM}}
\DoxyCodeLine{00002\ \textcolor{comment}{//}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ \ "{}fdrs\_node.h"{}}}
\DoxyCodeLine{00004\ \textcolor{comment}{//}}
\DoxyCodeLine{00005\ \textcolor{comment}{//\ \ Developed\ by\ Timm\ Bogner\ (timmbogner@gmail.com)\ in\ Urbana,\ Illinois,\ USA.}}
\DoxyCodeLine{00006\ \textcolor{comment}{//}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{fdrs__datatypes_8h}{fdrs\_datatypes.h}}>}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{fdrs__globals_8h}{fdrs\_globals.h}}>}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#define\ FDRS\_NODE}}
\DoxyCodeLine{00010\ }
\DoxyCodeLine{00011\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{fdrs__node_8h_a2723b85285fa34ac2e3cc9777f9af6a0}{is\_controller}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00012\ \mbox{\hyperlink{fdrs__datatypes_8h_a7b09e766d667a010c474eeb88632d1d5}{DataReading}}\ \mbox{\hyperlink{fdrs__node_8h_a718ba593017f95b5e4a74c39d9ad852f}{theData}}[256];}
\DoxyCodeLine{00013\ uint8\_t\ \mbox{\hyperlink{fdrs__node_8h_aabf3459d6bb55f6124eaba25e6ad6609}{ln}};}
\DoxyCodeLine{00014\ uint8\_t\ \mbox{\hyperlink{fdrs__node_8h_a21b4ef48eaa41b25a7933ead71d376c4}{newData}}\ =\ \mbox{\hyperlink{fdrs__datatypes_8h_a06fc87d81c62e9abb8790b6e5713c55ba9698f47448b941c623678667bae750f4}{event\_clear}};}
\DoxyCodeLine{00015\ uint8\_t\ \mbox{\hyperlink{fdrs__node_8h_a62994e4f9af5770586faddf3c4d2b084}{gatewayAddress}}[]\ =\ \{\mbox{\hyperlink{fdrs__globals_8h_a1c8c5652d0d3f46c81014158b9a58cb5}{MAC\_PREFIX}},\ GTWY\_MAC\};}
\DoxyCodeLine{00016\ \textcolor{keyword}{const}\ uint16\_t\ \mbox{\hyperlink{fdrs__node_8h_acd1fb24eef3069b10d19dc94740c36e7}{espnow\_size}}\ =\ 250\ /\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{fdrs__datatypes_8h_a7b09e766d667a010c474eeb88632d1d5}{DataReading}});}
\DoxyCodeLine{00017\ \mbox{\hyperlink{fdrs__datatypes_8h_a837c0fc43b79ca95e0a7141424043560}{crcResult}}\ \mbox{\hyperlink{fdrs__node_8h_af346f9786959d3e7cb99636370094e98}{crcReturned}}\ =\ \mbox{\hyperlink{fdrs__datatypes_8h_a837c0fc43b79ca95e0a7141424043560ac037419533386993875162c16f43800a}{CRC\_NULL}};}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ uint8\_t\ \mbox{\hyperlink{fdrs__node_8h_a1989a6c476a1dc6a3b37cebb2b1bc3f9}{incMAC}}[6];}
\DoxyCodeLine{00020\ \mbox{\hyperlink{fdrs__datatypes_8h_a7b09e766d667a010c474eeb88632d1d5}{DataReading}}\ \mbox{\hyperlink{fdrs__node_8h_ad47e902222297e6caf24d71774231801}{fdrsData}}[\mbox{\hyperlink{fdrs__node_8h_acd1fb24eef3069b10d19dc94740c36e7}{espnow\_size}}];}
\DoxyCodeLine{00021\ \mbox{\hyperlink{fdrs__datatypes_8h_a7b09e766d667a010c474eeb88632d1d5}{DataReading}}\ \mbox{\hyperlink{fdrs__node_8h_ac8c10615f76a7accd000533eee204294}{incData}}[\mbox{\hyperlink{fdrs__node_8h_acd1fb24eef3069b10d19dc94740c36e7}{espnow\_size}}];}
\DoxyCodeLine{00022\ \mbox{\hyperlink{struct_time_source}{TimeSource}}\ \mbox{\hyperlink{fdrs__node_8h_a527cdff0000383c77ef8828e6210e9c9}{timeSource}};}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00024\ uint8\_t\ \mbox{\hyperlink{fdrs__node_8h_ac3b7d313e05d69579ffdb37e62ba56ee}{data\_count}}\ =\ 0;}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00026\ void\ (*\mbox{\hyperlink{fdrs__node_8h_a372cb11afb62e03b6bc11ca6c050fd28}{callback\_ptr}})(\mbox{\hyperlink{fdrs__datatypes_8h_a7b09e766d667a010c474eeb88632d1d5}{DataReading}});}
\DoxyCodeLine{00027\ uint16\_t\ \mbox{\hyperlink{fdrs__node_8h_afd87a27759c65f6c991edbf9961ac6bc}{subscription\_list}}[256]\ =\ \{\};}
\DoxyCodeLine{00028\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{fdrs__node_8h_a856e8070073106907388299644bc9e05}{active\_subs}}[256]\ =\ \{\};}
\DoxyCodeLine{00029\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ \mbox{\hyperlink{fdrs__node_8h_ae8393fcc1c0ed907b8edaa9d75069f6c}{lastTimePrint}}\ =\ 0;}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{fdrs__node_8h_a34baf31b0b954403e1432d3cdb85a90d}{sendTimeSerial}}();}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ }
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#ifdef\ USE\_I2C}}
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\ \ \#include\ <Wire.h>}}
\DoxyCodeLine{00036\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00037\ \textcolor{preprocessor}{\#ifdef\ USE\_OLED}}
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\ \ \#include\ "{}\mbox{\hyperlink{fdrs__oled_8h}{fdrs\_oled.h}}"{}}}
\DoxyCodeLine{00039\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00040\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{fdrs__debug_8h}{fdrs\_debug.h}}"{}}}
\DoxyCodeLine{00041\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{fdrs__time_8h}{fdrs\_time.h}}"{}}}
\DoxyCodeLine{00042\ \textcolor{preprocessor}{\#ifdef\ DEBUG\_CONFIG}}
\DoxyCodeLine{00043\ \textcolor{comment}{//\ \#include\ "{}fdrs\_checkConfig.h"{}}}
\DoxyCodeLine{00044\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00045\ \textcolor{preprocessor}{\#ifdef\ USE\_ESPNOW}}
\DoxyCodeLine{00046\ \textcolor{preprocessor}{\ \ \#include\ "{}\mbox{\hyperlink{fdrs__node__espnow_8h}{fdrs\_node\_espnow.h}}"{}}}
\DoxyCodeLine{00047\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00048\ \textcolor{preprocessor}{\#ifdef\ USE\_LORA}}
\DoxyCodeLine{00049\ \textcolor{preprocessor}{\ \ \#include\ "{}\mbox{\hyperlink{fdrs__lora_8h}{fdrs\_lora.h}}"{}}}
\DoxyCodeLine{00050\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00052\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{fdrs__node_8h_ac431b68b62858d6c5b98c6ead232c19c}{beginFDRS}}()}
\DoxyCodeLine{00053\ \{}
\DoxyCodeLine{00054\ \ \ Serial.begin(115200);}
\DoxyCodeLine{00055\ \ \ \textcolor{comment}{//\ //\ find\ out\ the\ reset\ reason}}
\DoxyCodeLine{00056\ \ \ \textcolor{comment}{//\ esp\_reset\_reason\_t\ resetReason;}}
\DoxyCodeLine{00057\ \ \ \textcolor{comment}{//\ resetReason\ =\ esp\_reset\_reason();}}
\DoxyCodeLine{00058\ \textcolor{preprocessor}{\#ifdef\ USE\_I2C}}
\DoxyCodeLine{00059\ \ \ Wire.begin(I2C\_SDA,\ I2C\_SCL);}
\DoxyCodeLine{00060\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00061\ \textcolor{preprocessor}{\#ifdef\ USE\_OLED}}
\DoxyCodeLine{00062\ \ \ \mbox{\hyperlink{fdrs__oled_8h_a7146bcf63d6f02cf65be385af76565ed}{init\_oled}}();}
\DoxyCodeLine{00063\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}Display\ initialized!"{}});}
\DoxyCodeLine{00064\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}Hello,\ World!"{}});}
\DoxyCodeLine{00065\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00066\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{00067\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}Initializing\ FDRS\ Node!"{}});}
\DoxyCodeLine{00068\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}Reading\ ID\ "{}}\ +\ String(READING\_ID));}
\DoxyCodeLine{00069\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}Gateway:\ "{}}\ +\ String(GTWY\_MAC,\ HEX));}
\DoxyCodeLine{00070\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}Debugging\ verbosity\ level:\ "{}}\ +\ String(\mbox{\hyperlink{fdrs__debug_8h_a26d753a2fda1c4540cb1ad13cbe78192}{DBG\_LEVEL}}));}
\DoxyCodeLine{00071\ \textcolor{preprocessor}{\#ifdef\ USE\_ESPNOW}}
\DoxyCodeLine{00072\ \ \ \mbox{\hyperlink{fdrs__debug_8h_ab6996efcae0768c394bb02b0d2951ffb}{DBG1}}(\textcolor{stringliteral}{"{}ESP-\/NOW\ is\ enabled."{}});}
\DoxyCodeLine{00073\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00074\ \textcolor{preprocessor}{\#ifdef\ USE\_LORA}}
\DoxyCodeLine{00075\ \ \ \mbox{\hyperlink{fdrs__debug_8h_ab6996efcae0768c394bb02b0d2951ffb}{DBG1}}(\textcolor{stringliteral}{"{}LoRa\ is\ enabled."{}});}
\DoxyCodeLine{00076\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00077\ \textcolor{preprocessor}{\#ifdef\ DEEP\_SLEEP}}
\DoxyCodeLine{00078\ \ \ \mbox{\hyperlink{fdrs__debug_8h_ab6996efcae0768c394bb02b0d2951ffb}{DBG1}}(\textcolor{stringliteral}{"{}Deep\ sleep\ is\ enabled."{}});}
\DoxyCodeLine{00079\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00080\ \textcolor{preprocessor}{\#ifdef\ POWER\_CTRL}}
\DoxyCodeLine{00081\ \ \ \mbox{\hyperlink{fdrs__debug_8h_ab6996efcae0768c394bb02b0d2951ffb}{DBG1}}(\textcolor{stringliteral}{"{}Power\ control\ is\ enabled\ on\ pin\ "{}}\ +\ String(POWER\_CTRL));}
\DoxyCodeLine{00082\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}Powering\ up\ the\ sensor\ array!"{}});}
\DoxyCodeLine{00083\ \ \ pinMode(POWER\_CTRL,\ OUTPUT);}
\DoxyCodeLine{00084\ \ \ digitalWrite(POWER\_CTRL,\ 1);}
\DoxyCodeLine{00085\ \ \ delay(50);}
\DoxyCodeLine{00086\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00087\ \ \ \textcolor{comment}{//\ Init\ ESP-\/NOW\ for\ either\ ESP8266\ or\ ESP32}}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00089\ \textcolor{preprocessor}{\#ifdef\ USE\_ESPNOW}}
\DoxyCodeLine{00090\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}Initializing\ ESP-\/NOW!"{}});}
\DoxyCodeLine{00091\ \ \ WiFi.mode(WIFI\_STA);}
\DoxyCodeLine{00092\ \ \ WiFi.disconnect();}
\DoxyCodeLine{00093\ \textcolor{preprocessor}{\#if\ defined(ESP8266)}}
\DoxyCodeLine{00094\ \textcolor{preprocessor}{\#ifdef\ USE\_LR}}
\DoxyCodeLine{00095\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}\ LR\ mode\ is\ only\ available\ on\ ESP32.\ ESP-\/NOW\ will\ begin\ in\ normal\ mode."{}});}
\DoxyCodeLine{00096\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00097\ \ \ \textcolor{keywordflow}{if}\ (esp\_now\_init()\ !=\ 0)}
\DoxyCodeLine{00098\ \ \ \{}
\DoxyCodeLine{00099\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00100\ \ \ \}}
\DoxyCodeLine{00101\ \ \ esp\_now\_set\_self\_role(ESP\_NOW\_ROLE\_COMBO);}
\DoxyCodeLine{00102\ \ \ esp\_now\_register\_recv\_cb(OnDataRecv);}
\DoxyCodeLine{00103\ \ \ esp\_now\_register\_send\_cb(OnDataSent);}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \ \ \textcolor{comment}{//\ Register\ peers}}
\DoxyCodeLine{00106\ \ \ esp\_now\_add\_peer(\mbox{\hyperlink{fdrs__node_8h_a62994e4f9af5770586faddf3c4d2b084}{gatewayAddress}},\ ESP\_NOW\_ROLE\_COMBO,\ 0,\ NULL,\ 0);}
\DoxyCodeLine{00107\ \textcolor{preprocessor}{\#elif\ defined(ESP32)}}
\DoxyCodeLine{00108\ \textcolor{preprocessor}{\#ifdef\ USE\_LR}}
\DoxyCodeLine{00109\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}\ ESP-\/NOW\ LR\ mode\ is\ active!"{}});}
\DoxyCodeLine{00110\ \ \ esp\_wifi\_set\_protocol(WIFI\_IF\_STA,\ WIFI\_PROTOCOL\_LR);}
\DoxyCodeLine{00111\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00112\ \ \ \textcolor{keywordflow}{if}\ (esp\_now\_init()\ !=\ \mbox{\hyperlink{fdrs__datatypes_8h_abdbffa06442bc1fe3d65dbb8d17656d1}{ESP\_OK}})}
\DoxyCodeLine{00113\ \ \ \{}
\DoxyCodeLine{00114\ \ \ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}Error\ initializing\ ESP-\/NOW"{}});}
\DoxyCodeLine{00115\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00116\ \ \ \}}
\DoxyCodeLine{00117\ \ \ esp\_now\_register\_recv\_cb(OnDataRecv);}
\DoxyCodeLine{00118\ \ \ esp\_now\_register\_send\_cb(OnDataSent);}
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00120\ \ \ esp\_now\_peer\_info\_t\ peerInfo;}
\DoxyCodeLine{00121\ \ \ peerInfo.ifidx\ =\ WIFI\_IF\_STA;}
\DoxyCodeLine{00122\ \ \ peerInfo.channel\ =\ 0;}
\DoxyCodeLine{00123\ \ \ peerInfo.encrypt\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00124\ \ \ memcpy(peerInfo.peer\_addr,\ \mbox{\hyperlink{fdrs__gateway__espnow_8h_a34d4c0660922c991d45752f5704407bb}{broadcast\_mac}},\ 6);}
\DoxyCodeLine{00125\ \ \ \textcolor{keywordflow}{if}\ (esp\_now\_add\_peer(\&peerInfo)\ !=\ \mbox{\hyperlink{fdrs__datatypes_8h_abdbffa06442bc1fe3d65dbb8d17656d1}{ESP\_OK}})}
\DoxyCodeLine{00126\ \ \ \{}
\DoxyCodeLine{00127\ \ \ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}\ Failed\ to\ add\ peer\ bcast"{}});}
\DoxyCodeLine{00128\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00129\ \ \ \}}
\DoxyCodeLine{00130\ \ \ memcpy(peerInfo.peer\_addr,\ \mbox{\hyperlink{fdrs__node_8h_a62994e4f9af5770586faddf3c4d2b084}{gatewayAddress}},\ 6);}
\DoxyCodeLine{00131\ \ \ \textcolor{keywordflow}{if}\ (esp\_now\_add\_peer(\&peerInfo)\ !=\ \mbox{\hyperlink{fdrs__datatypes_8h_abdbffa06442bc1fe3d65dbb8d17656d1}{ESP\_OK}})}
\DoxyCodeLine{00132\ \ \ \{}
\DoxyCodeLine{00133\ \ \ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}\ Failed\ to\ add\ peer"{}});}
\DoxyCodeLine{00134\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00135\ \ \ \}}
\DoxyCodeLine{00136\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00137\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}\ ESP-\/NOW\ Initialized."{}});}
\DoxyCodeLine{00138\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ USE\_ESPNOW}}
\DoxyCodeLine{00139\ \textcolor{preprocessor}{\#ifdef\ USE\_LORA}}
\DoxyCodeLine{00140\ \ \ \mbox{\hyperlink{fdrs__lora_8h_a891be47f9b62be2d0335d591e4f3fc0e}{begin\_lora}}();}
\DoxyCodeLine{00141\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00142\ \textcolor{preprocessor}{\#ifdef\ DEBUG\_CONFIG}}
\DoxyCodeLine{00143\ \ \ \textcolor{comment}{//\ if\ (resetReason\ !=\ ESP\_RST\_DEEPSLEEP)\ \{}}
\DoxyCodeLine{00144\ \ \ \textcolor{comment}{//\ checkConfig();}}
\DoxyCodeLine{00145\ \ \ \textcolor{comment}{//\ \}}}
\DoxyCodeLine{00146\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ DEBUG\_CONFIG}}
\DoxyCodeLine{00147\ \}}
\DoxyCodeLine{00148\ }
\DoxyCodeLine{00149\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{fdrs__node_8h_aea0f24207e344268d66c8823da1a6b3b}{handleIncoming}}()}
\DoxyCodeLine{00150\ \{}
\DoxyCodeLine{00151\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{fdrs__node_8h_a21b4ef48eaa41b25a7933ead71d376c4}{newData}}\ !=\ \mbox{\hyperlink{fdrs__datatypes_8h_a06fc87d81c62e9abb8790b6e5713c55ba9698f47448b941c623678667bae750f4}{event\_clear}})}
\DoxyCodeLine{00152\ \ \ \{}
\DoxyCodeLine{00153\ }
\DoxyCodeLine{00154\ \ \ \ \ \mbox{\hyperlink{fdrs__node_8h_a21b4ef48eaa41b25a7933ead71d376c4}{newData}}\ =\ \mbox{\hyperlink{fdrs__datatypes_8h_a06fc87d81c62e9abb8790b6e5713c55ba9698f47448b941c623678667bae750f4}{event\_clear}};}
\DoxyCodeLine{00155\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ \mbox{\hyperlink{fdrs__node_8h_aabf3459d6bb55f6124eaba25e6ad6609}{ln}};\ i++)}
\DoxyCodeLine{00156\ \ \ \ \ \{\ \textcolor{comment}{//\ Cycle\ through\ array\ of\ incoming\ DataReadings\ for\ any\ we\ are\ subbed\ to}}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ j\ =\ 0;\ j\ <\ 255;\ j++)}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \{\ \textcolor{comment}{//\ Cycle\ through\ subscriptions\ for\ active\ entries}}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{fdrs__node_8h_a856e8070073106907388299644bc9e05}{active\_subs}}[j])}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00161\ }
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{fdrs__node_8h_a718ba593017f95b5e4a74c39d9ad852f}{theData}}[i].\textcolor{keywordtype}{id}\ ==\ \mbox{\hyperlink{fdrs__node_8h_afd87a27759c65f6c991edbf9961ac6bc}{subscription\_list}}[j])}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ \ \ \ \ (*callback\_ptr)(\mbox{\hyperlink{fdrs__node_8h_a718ba593017f95b5e4a74c39d9ad852f}{theData}}[i]);}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00169\ \ \ \ \ \}}
\DoxyCodeLine{00170\ \ \ \}}
\DoxyCodeLine{00171\ \}}
\DoxyCodeLine{00172\ }
\DoxyCodeLine{00173\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{fdrs__node_8h_a64745a833c9677a26efc67db402ba160}{sendFDRS}}()}
\DoxyCodeLine{00174\ \{}
\DoxyCodeLine{00175\ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{fdrs__node_8h_ac3b7d313e05d69579ffdb37e62ba56ee}{data\_count}}\ ==\ 0)\ \{}
\DoxyCodeLine{00176\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00177\ \ \ \}}
\DoxyCodeLine{00178\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}Sending\ FDRS\ Packet!"{}});}
\DoxyCodeLine{00179\ \textcolor{preprocessor}{\#ifdef\ USE\_ESPNOW}}
\DoxyCodeLine{00180\ \ \ esp\_now\_send(\mbox{\hyperlink{fdrs__node_8h_a62994e4f9af5770586faddf3c4d2b084}{gatewayAddress}},\ (uint8\_t\ *)\&\mbox{\hyperlink{fdrs__node_8h_ad47e902222297e6caf24d71774231801}{fdrsData}},\ \mbox{\hyperlink{fdrs__node_8h_ac3b7d313e05d69579ffdb37e62ba56ee}{data\_count}}\ *\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{fdrs__datatypes_8h_a7b09e766d667a010c474eeb88632d1d5}{DataReading}}));}
\DoxyCodeLine{00181\ \ \ \mbox{\hyperlink{fdrs__node__espnow_8h_af9986b51f94d31e0ff433635a7fac0bc}{esp\_now\_ack\_flag}}\ =\ \mbox{\hyperlink{fdrs__datatypes_8h_a837c0fc43b79ca95e0a7141424043560ac037419533386993875162c16f43800a}{CRC\_NULL}};}
\DoxyCodeLine{00182\ \ \ \textcolor{keywordflow}{while}\ (\mbox{\hyperlink{fdrs__node__espnow_8h_af9986b51f94d31e0ff433635a7fac0bc}{esp\_now\_ack\_flag}}\ ==\ \mbox{\hyperlink{fdrs__datatypes_8h_a837c0fc43b79ca95e0a7141424043560ac037419533386993875162c16f43800a}{CRC\_NULL}})}
\DoxyCodeLine{00183\ \ \ \{}
\DoxyCodeLine{00184\ \ \ \ \ yield();}
\DoxyCodeLine{00185\ \ \ \ \ delay(0);}
\DoxyCodeLine{00186\ \ \ \}}
\DoxyCodeLine{00187\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{fdrs__node__espnow_8h_af9986b51f94d31e0ff433635a7fac0bc}{esp\_now\_ack\_flag}}\ ==\ \mbox{\hyperlink{fdrs__datatypes_8h_a837c0fc43b79ca95e0a7141424043560ae989d9d773a74fcc7a0efce652f99ece}{CRC\_OK}})}
\DoxyCodeLine{00188\ \ \ \{}
\DoxyCodeLine{00189\ \ \ \ \ \mbox{\hyperlink{fdrs__node_8h_ac3b7d313e05d69579ffdb37e62ba56ee}{data\_count}}\ =\ 0;}
\DoxyCodeLine{00190\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00191\ \ \ \}}
\DoxyCodeLine{00192\ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00193\ \ \ \{}
\DoxyCodeLine{00194\ \ \ \ \ \mbox{\hyperlink{fdrs__node_8h_ac3b7d313e05d69579ffdb37e62ba56ee}{data\_count}}\ =\ 0;}
\DoxyCodeLine{00195\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00196\ \ \ \}}
\DoxyCodeLine{00197\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00198\ \textcolor{preprocessor}{\#ifdef\ USE\_LORA}}
\DoxyCodeLine{00199\ \ \ \mbox{\hyperlink{fdrs__lora_8h_a6c7409e91d4bbc41a6fba6852be9ed42}{transmitLoRaAsync}}(\&gtwyAddress,\ \mbox{\hyperlink{fdrs__node_8h_ad47e902222297e6caf24d71774231801}{fdrsData}},\ \mbox{\hyperlink{fdrs__node_8h_ac3b7d313e05d69579ffdb37e62ba56ee}{data\_count}});}
\DoxyCodeLine{00200\ \ \ \textcolor{comment}{//\ DBG("{}\ LoRa\ sent."{});}}
\DoxyCodeLine{00201\ \textcolor{preprocessor}{\#ifdef\ LORA\_ACK}}
\DoxyCodeLine{00202\ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{fdrs__node_8h_af346f9786959d3e7cb99636370094e98}{crcReturned}}\ ==\ \mbox{\hyperlink{fdrs__datatypes_8h_a837c0fc43b79ca95e0a7141424043560ae989d9d773a74fcc7a0efce652f99ece}{CRC\_OK}})\ \{}
\DoxyCodeLine{00203\ \ \ \mbox{\hyperlink{fdrs__node_8h_ac3b7d313e05d69579ffdb37e62ba56ee}{data\_count}}\ =\ 0;}
\DoxyCodeLine{00204\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00205\ \ \ \}}
\DoxyCodeLine{00206\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00207\ \textcolor{preprocessor}{\#ifndef\ LORA\_ACK}}
\DoxyCodeLine{00208\ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{fdrs__node_8h_af346f9786959d3e7cb99636370094e98}{crcReturned}}\ ==\ \mbox{\hyperlink{fdrs__datatypes_8h_a837c0fc43b79ca95e0a7141424043560ae989d9d773a74fcc7a0efce652f99ece}{CRC\_OK}}\ ||\ \mbox{\hyperlink{fdrs__node_8h_af346f9786959d3e7cb99636370094e98}{crcReturned}}\ ==\ \mbox{\hyperlink{fdrs__datatypes_8h_a837c0fc43b79ca95e0a7141424043560ac037419533386993875162c16f43800a}{CRC\_NULL}})\ \{}
\DoxyCodeLine{00209\ \ \ \ \ \mbox{\hyperlink{fdrs__node_8h_ac3b7d313e05d69579ffdb37e62ba56ee}{data\_count}}\ =\ 0;}
\DoxyCodeLine{00210\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00211\ \}}
\DoxyCodeLine{00212\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00213\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00214\ \ \ \ \ \mbox{\hyperlink{fdrs__node_8h_ac3b7d313e05d69579ffdb37e62ba56ee}{data\_count}}\ =\ 0;}
\DoxyCodeLine{00215\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00216\ \ \ \}}
\DoxyCodeLine{00217\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00218\ \}}
\DoxyCodeLine{00219\ }
\DoxyCodeLine{00220\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{fdrs__node_8h_a9fdc47b57ce98874f66e9a142d0fdba5}{loadFDRS}}(\textcolor{keywordtype}{float}\ d,\ uint8\_t\ t)}
\DoxyCodeLine{00221\ \{}
\DoxyCodeLine{00222\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}Id:\ "{}}\ +\ String(READING\_ID)\ +\ \textcolor{stringliteral}{"{}\ -\/\ Type:\ "{}}\ +\ String(t)\ +\ \textcolor{stringliteral}{"{}\ -\/\ Data\ loaded:\ "{}}\ +\ String(d));}
\DoxyCodeLine{00223\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{fdrs__node_8h_ac3b7d313e05d69579ffdb37e62ba56ee}{data\_count}}\ >\ \mbox{\hyperlink{fdrs__node_8h_acd1fb24eef3069b10d19dc94740c36e7}{espnow\_size}})}
\DoxyCodeLine{00224\ \ \ \ \ \mbox{\hyperlink{fdrs__node_8h_a64745a833c9677a26efc67db402ba160}{sendFDRS}}();}
\DoxyCodeLine{00225\ \ \ \mbox{\hyperlink{fdrs__datatypes_8h_a7b09e766d667a010c474eeb88632d1d5}{DataReading}}\ dr;}
\DoxyCodeLine{00226\ \ \ dr.id\ =\ READING\_ID;}
\DoxyCodeLine{00227\ \ \ dr.t\ =\ t;}
\DoxyCodeLine{00228\ \ \ dr.d\ =\ d;}
\DoxyCodeLine{00229\ \ \ \mbox{\hyperlink{fdrs__node_8h_ad47e902222297e6caf24d71774231801}{fdrsData}}[\mbox{\hyperlink{fdrs__node_8h_ac3b7d313e05d69579ffdb37e62ba56ee}{data\_count}}]\ =\ dr;}
\DoxyCodeLine{00230\ \ \ \mbox{\hyperlink{fdrs__node_8h_ac3b7d313e05d69579ffdb37e62ba56ee}{data\_count}}++;}
\DoxyCodeLine{00231\ \}}
\DoxyCodeLine{00232\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{fdrs__node_8h_a9fdc47b57ce98874f66e9a142d0fdba5}{loadFDRS}}(\textcolor{keywordtype}{float}\ d,\ uint8\_t\ t,\ uint16\_t\ \textcolor{keywordtype}{id})}
\DoxyCodeLine{00233\ \{}
\DoxyCodeLine{00234\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}Id:\ "{}}\ +\ String(\textcolor{keywordtype}{id})\ +\ \textcolor{stringliteral}{"{}\ -\/\ Type:\ "{}}\ +\ String(t)\ +\ \textcolor{stringliteral}{"{}\ -\/\ Data\ loaded:\ "{}}\ +\ String(d));}
\DoxyCodeLine{00235\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{fdrs__node_8h_ac3b7d313e05d69579ffdb37e62ba56ee}{data\_count}}\ >\ \mbox{\hyperlink{fdrs__node_8h_acd1fb24eef3069b10d19dc94740c36e7}{espnow\_size}})}
\DoxyCodeLine{00236\ \ \ \ \ \mbox{\hyperlink{fdrs__node_8h_a64745a833c9677a26efc67db402ba160}{sendFDRS}}();}
\DoxyCodeLine{00237\ \ \ \mbox{\hyperlink{fdrs__datatypes_8h_a7b09e766d667a010c474eeb88632d1d5}{DataReading}}\ dr;}
\DoxyCodeLine{00238\ \ \ dr.id\ =\ id;}
\DoxyCodeLine{00239\ \ \ dr.t\ =\ t;}
\DoxyCodeLine{00240\ \ \ dr.d\ =\ d;}
\DoxyCodeLine{00241\ \ \ \mbox{\hyperlink{fdrs__node_8h_ad47e902222297e6caf24d71774231801}{fdrsData}}[\mbox{\hyperlink{fdrs__node_8h_ac3b7d313e05d69579ffdb37e62ba56ee}{data\_count}}]\ =\ dr;}
\DoxyCodeLine{00242\ \ \ \mbox{\hyperlink{fdrs__node_8h_ac3b7d313e05d69579ffdb37e62ba56ee}{data\_count}}++;}
\DoxyCodeLine{00243\ \}}
\DoxyCodeLine{00244\ }
\DoxyCodeLine{00245\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{fdrs__node_8h_abedc4a084f291ab9b3f1dea00b0b4e17}{sleepFDRS}}(uint32\_t\ sleep\_time)}
\DoxyCodeLine{00246\ \{}
\DoxyCodeLine{00247\ \textcolor{preprocessor}{\#ifdef\ DEEP\_SLEEP}}
\DoxyCodeLine{00248\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}\ Deep\ sleeping."{}});}
\DoxyCodeLine{00249\ \textcolor{preprocessor}{\#ifdef\ ESP32}}
\DoxyCodeLine{00250\ \ \ esp\_sleep\_enable\_timer\_wakeup(sleep\_time\ *\ 1000000ULL);}
\DoxyCodeLine{00251\ \ \ esp\_deep\_sleep\_start();}
\DoxyCodeLine{00252\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00253\ \textcolor{preprocessor}{\#ifdef\ ESP8266}}
\DoxyCodeLine{00254\ \ \ ESP.deepSleep(sleep\_time\ *\ 1000000);}
\DoxyCodeLine{00255\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00256\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00257\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}\ Delaying."{}});}
\DoxyCodeLine{00258\ \ \ \ \ delay(sleep\_time\ *\ 1000);}
\DoxyCodeLine{00259\ \}}
\DoxyCodeLine{00260\ }
\DoxyCodeLine{00261\ }
\DoxyCodeLine{00262\ }
\DoxyCodeLine{00263\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{fdrs__node_8h_a6f2cba0bda6e085f28dc8fbca81f67e2}{loopFDRS}}()}
\DoxyCodeLine{00264\ \{}
\DoxyCodeLine{00265\ \ \ \mbox{\hyperlink{fdrs__time_8h_ad0e793229e13e28a85d7e7065130beee}{handleTime}}();}
\DoxyCodeLine{00266\ \textcolor{preprocessor}{\#ifdef\ USE\_LORA}}
\DoxyCodeLine{00267\ \ \ \mbox{\hyperlink{fdrs__gateway_8h_afcfa506ffe12e69a13e036bf2c186df8}{handleLoRa}}();}
\DoxyCodeLine{00268\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00269\ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{fdrs__node_8h_a2723b85285fa34ac2e3cc9777f9af6a0}{is\_controller}})\{}
\DoxyCodeLine{00270\ \ \ \mbox{\hyperlink{fdrs__node_8h_aea0f24207e344268d66c8823da1a6b3b}{handleIncoming}}();}
\DoxyCodeLine{00271\ \textcolor{preprocessor}{\#ifdef\ USE\_ESPNOW}}
\DoxyCodeLine{00272\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{fdrs__time_8h_a21663dd18026eef043bcf3e1467bf8ae}{TDIFF}}(\mbox{\hyperlink{fdrs__node__espnow_8h_a2558f47ad0e65eccfed0ec60a439b2b6}{last\_refresh}},\mbox{\hyperlink{fdrs__node__espnow_8h_adb2a6bbbe5ef5788763c5704447aa841}{gtwy\_timeout}}))}
\DoxyCodeLine{00273\ \ \ \ \ \{}
\DoxyCodeLine{00274\ \ \ \ \ \ \ \mbox{\hyperlink{fdrs__node__espnow_8h_a0dd24254d04c564dc46439620349fbff}{refresh\_registration}}();}
\DoxyCodeLine{00275\ \ \ \ \ \ \ \mbox{\hyperlink{fdrs__node__espnow_8h_a2558f47ad0e65eccfed0ec60a439b2b6}{last\_refresh}}\ =\ millis();}
\DoxyCodeLine{00276\ \ \ \ \ \}}
\DoxyCodeLine{00277\ \textcolor{preprocessor}{\#endif\ }}
\DoxyCodeLine{00278\ \ \ \}}
\DoxyCodeLine{00279\ \ \ \textcolor{comment}{//\ Output\ time\ to\ display\ if\ time\ is\ valid}}
\DoxyCodeLine{00280\ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{fdrs__time_8h_adbb44fde32f342c98a304566f0e5c913}{TDIFFMIN}}(\mbox{\hyperlink{fdrs__node_8h_ae8393fcc1c0ed907b8edaa9d75069f6c}{lastTimePrint}},\mbox{\hyperlink{fdrs__time_8h_ab3b37f5632f054d4ae3c724839bb03b2}{FDRS\_TIME\_PRINTTIME}}))\ \{}
\DoxyCodeLine{00281\ \ \ \ \ \mbox{\hyperlink{fdrs__node_8h_ae8393fcc1c0ed907b8edaa9d75069f6c}{lastTimePrint}}\ =\ millis();}
\DoxyCodeLine{00282\ \ \ \ \ \mbox{\hyperlink{fdrs__time_8h_ac78edd18ba18ffa2288ef058728b6c18}{printTime}}();}
\DoxyCodeLine{00283\ \ \ \}}
\DoxyCodeLine{00284\ \}}
\DoxyCodeLine{00285\ }
\DoxyCodeLine{00286\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{fdrs__node_8h_afb421cb4fc8f12c66c1a1b698b4774e8}{addFDRS}}(\textcolor{keywordtype}{void}\ (*new\_cb\_ptr)(\mbox{\hyperlink{fdrs__datatypes_8h_a7b09e766d667a010c474eeb88632d1d5}{DataReading}}))}
\DoxyCodeLine{00287\ \{}
\DoxyCodeLine{00288\ \ \ \mbox{\hyperlink{fdrs__node_8h_a2723b85285fa34ac2e3cc9777f9af6a0}{is\_controller}}\ =\ \textcolor{keyword}{true};\ \ }
\DoxyCodeLine{00289\ \ \ \mbox{\hyperlink{fdrs__node_8h_a372cb11afb62e03b6bc11ca6c050fd28}{callback\_ptr}}\ =\ new\_cb\_ptr;}
\DoxyCodeLine{00290\ \textcolor{preprocessor}{\#ifdef\ USE\_ESPNOW}}
\DoxyCodeLine{00291\ \ \ \mbox{\hyperlink{fdrs__datatypes_8h_a4e94df1a3d0c53bbaf8d6fb6e8eb4898}{SystemPacket}}\ sys\_packet\ =\ \{.cmd\ =\ \mbox{\hyperlink{fdrs__datatypes_8h_a00d51b3cb2e1fa09bdba2968e0cf7ac7a68be1663ccc07658d86f96f32c25febf}{cmd\_add}},\ .param\ =\ 0\};}
\DoxyCodeLine{00292\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}ESP-\/NOW\ peer\ registration\ request\ submitted\ to\ 0x"{}}\ +\ String(\mbox{\hyperlink{fdrs__node_8h_a62994e4f9af5770586faddf3c4d2b084}{gatewayAddress}}[5],HEX));}
\DoxyCodeLine{00293\ \ \ uint32\_t\ add\_start\ =\ millis();}
\DoxyCodeLine{00294\ \ \ \mbox{\hyperlink{fdrs__node__espnow_8h_acb5dd44a029f38b21e0df8d5155e7f1e}{is\_added}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00295\ \ \ esp\_now\_send(\mbox{\hyperlink{fdrs__node_8h_a62994e4f9af5770586faddf3c4d2b084}{gatewayAddress}},\ (uint8\_t\ *)\&sys\_packet,\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{fdrs__datatypes_8h_a4e94df1a3d0c53bbaf8d6fb6e8eb4898}{SystemPacket}}));}
\DoxyCodeLine{00296\ \ \ \textcolor{keywordflow}{while}\ ((millis()\ -\/\ add\_start)\ <=\ 1000)\ \textcolor{comment}{//\ 1000ms\ timeout}}
\DoxyCodeLine{00297\ \ \ \{}
\DoxyCodeLine{00298\ \ \ \ \ yield();}
\DoxyCodeLine{00299\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{fdrs__node__espnow_8h_acb5dd44a029f38b21e0df8d5155e7f1e}{is\_added}})}
\DoxyCodeLine{00300\ \ \ \ \ \{}
\DoxyCodeLine{00301\ \ \ \ \ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}Registration\ accepted.\ Timeout:\ "{}}\ +\ String(\mbox{\hyperlink{fdrs__node__espnow_8h_adb2a6bbbe5ef5788763c5704447aa841}{gtwy\_timeout}}));}
\DoxyCodeLine{00302\ \ \ \ \ \ \ \mbox{\hyperlink{fdrs__node__espnow_8h_a2558f47ad0e65eccfed0ec60a439b2b6}{last\_refresh}}\ =\ millis();}
\DoxyCodeLine{00303\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00304\ \ \ \ \ \}}
\DoxyCodeLine{00305\ \ \ \}}
\DoxyCodeLine{00306\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}No\ gateways\ accepted\ the\ request"{}});}
\DoxyCodeLine{00307\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00308\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ USE\_ESPNOW}}
\DoxyCodeLine{00309\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00310\ \}}
\DoxyCodeLine{00311\ }
\DoxyCodeLine{00312\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{fdrs__node_8h_afb421cb4fc8f12c66c1a1b698b4774e8}{addFDRS}}(\textcolor{keywordtype}{int}\ timeout,\ \textcolor{keywordtype}{void}\ (*new\_cb\_ptr)(\mbox{\hyperlink{fdrs__datatypes_8h_a7b09e766d667a010c474eeb88632d1d5}{DataReading}}))}
\DoxyCodeLine{00313\ \{}
\DoxyCodeLine{00314\ \ \ \mbox{\hyperlink{fdrs__node_8h_a2723b85285fa34ac2e3cc9777f9af6a0}{is\_controller}}\ =\ \textcolor{keyword}{true};\ \ }
\DoxyCodeLine{00315\ \ \ \mbox{\hyperlink{fdrs__node_8h_a372cb11afb62e03b6bc11ca6c050fd28}{callback\_ptr}}\ =\ new\_cb\_ptr;}
\DoxyCodeLine{00316\ \textcolor{preprocessor}{\#ifdef\ USE\_ESPNOW}}
\DoxyCodeLine{00317\ \ \ \mbox{\hyperlink{fdrs__datatypes_8h_a4e94df1a3d0c53bbaf8d6fb6e8eb4898}{SystemPacket}}\ sys\_packet\ =\ \{.cmd\ =\ \mbox{\hyperlink{fdrs__datatypes_8h_a00d51b3cb2e1fa09bdba2968e0cf7ac7a68be1663ccc07658d86f96f32c25febf}{cmd\_add}},\ .param\ =\ 0\};}
\DoxyCodeLine{00318\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}ESP-\/NOW\ peer\ registration\ request\ submitted\ to\ 0x"{}}\ +\ String(\mbox{\hyperlink{fdrs__node_8h_a62994e4f9af5770586faddf3c4d2b084}{gatewayAddress}}[5],HEX));}
\DoxyCodeLine{00319\ \ \ uint32\_t\ add\_start\ =\ millis();}
\DoxyCodeLine{00320\ \ \ \mbox{\hyperlink{fdrs__node__espnow_8h_acb5dd44a029f38b21e0df8d5155e7f1e}{is\_added}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00321\ \ \ esp\_now\_send(\mbox{\hyperlink{fdrs__node_8h_a62994e4f9af5770586faddf3c4d2b084}{gatewayAddress}},\ (uint8\_t\ *)\&sys\_packet,\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{fdrs__datatypes_8h_a4e94df1a3d0c53bbaf8d6fb6e8eb4898}{SystemPacket}}));}
\DoxyCodeLine{00322\ \ \ \textcolor{keywordflow}{while}\ ((millis()\ -\/\ add\_start)\ <=\ timeout)}
\DoxyCodeLine{00323\ \ \ \{}
\DoxyCodeLine{00324\ \ \ \ \ yield();}
\DoxyCodeLine{00325\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{fdrs__node__espnow_8h_acb5dd44a029f38b21e0df8d5155e7f1e}{is\_added}})}
\DoxyCodeLine{00326\ \ \ \ \ \{}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}Registration\ accepted.\ Timeout:\ "{}}\ +\ String(\mbox{\hyperlink{fdrs__node__espnow_8h_adb2a6bbbe5ef5788763c5704447aa841}{gtwy\_timeout}}));}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \mbox{\hyperlink{fdrs__node__espnow_8h_a2558f47ad0e65eccfed0ec60a439b2b6}{last\_refresh}}\ =\ millis();}
\DoxyCodeLine{00329\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00330\ \ \ \ \ \}}
\DoxyCodeLine{00331\ \ \ \}}
\DoxyCodeLine{00332\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}No\ gateways\ accepted\ the\ request"{}});}
\DoxyCodeLine{00333\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00334\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ USE\_ESPNOW}}
\DoxyCodeLine{00335\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00336\ \}}
\DoxyCodeLine{00337\ }
\DoxyCodeLine{00338\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{fdrs__node_8h_a506a9eb2e2ae0e5ae88036bad4507a66}{subscribeFDRS}}(uint16\_t\ sub\_id)}
\DoxyCodeLine{00339\ \{}
\DoxyCodeLine{00340\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 255;\ i++)}
\DoxyCodeLine{00341\ \ \ \{}
\DoxyCodeLine{00342\ \ \ \ \ \textcolor{keywordflow}{if}\ ((\mbox{\hyperlink{fdrs__node_8h_afd87a27759c65f6c991edbf9961ac6bc}{subscription\_list}}[i]\ ==\ sub\_id)\ \&\&\ (\mbox{\hyperlink{fdrs__node_8h_a856e8070073106907388299644bc9e05}{active\_subs}}[i]))}
\DoxyCodeLine{00343\ \ \ \ \ \{}
\DoxyCodeLine{00344\ \ \ \ \ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}You're\ already\ subscribed\ to\ ID\ "{}}\ +\ String(sub\_id));}
\DoxyCodeLine{00345\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00346\ \ \ \ \ \}}
\DoxyCodeLine{00347\ \ \ \}}
\DoxyCodeLine{00348\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 255;\ i++)}
\DoxyCodeLine{00349\ \ \ \{}
\DoxyCodeLine{00350\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{fdrs__node_8h_a856e8070073106907388299644bc9e05}{active\_subs}}[i])}
\DoxyCodeLine{00351\ \ \ \ \ \{}
\DoxyCodeLine{00352\ \ \ \ \ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}Subscribing\ to\ DataReading\ ID\ "{}}\ +\ String(sub\_id));}
\DoxyCodeLine{00353\ \ \ \ \ \ \ \mbox{\hyperlink{fdrs__node_8h_afd87a27759c65f6c991edbf9961ac6bc}{subscription\_list}}[i]\ =\ sub\_id;}
\DoxyCodeLine{00354\ \ \ \ \ \ \ \mbox{\hyperlink{fdrs__node_8h_a856e8070073106907388299644bc9e05}{active\_subs}}[i]\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00355\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00356\ \ \ \ \ \}}
\DoxyCodeLine{00357\ \ \ \}}
\DoxyCodeLine{00358\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}No\ subscription\ could\ be\ established!"{}});}
\DoxyCodeLine{00359\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00360\ \}}
\DoxyCodeLine{00361\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{fdrs__node_8h_a98a7127c569007670b7158c65c280ddf}{unsubscribeFDRS}}(uint16\_t\ sub\_id)}
\DoxyCodeLine{00362\ \{}
\DoxyCodeLine{00363\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 255;\ i++)}
\DoxyCodeLine{00364\ \ \ \{}
\DoxyCodeLine{00365\ \ \ \ \ \textcolor{keywordflow}{if}\ ((\mbox{\hyperlink{fdrs__node_8h_afd87a27759c65f6c991edbf9961ac6bc}{subscription\_list}}[i]\ ==\ sub\_id)\ \&\&\ (\mbox{\hyperlink{fdrs__node_8h_a856e8070073106907388299644bc9e05}{active\_subs}}[i]))}
\DoxyCodeLine{00366\ \ \ \ \ \{}
\DoxyCodeLine{00367\ \ \ \ \ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}Removing\ subscription\ to\ ID\ "{}}\ +\ String(sub\_id));}
\DoxyCodeLine{00368\ \ \ \ \ \ \ \mbox{\hyperlink{fdrs__node_8h_a856e8070073106907388299644bc9e05}{active\_subs}}[i]\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00369\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00370\ \ \ \ \ \}}
\DoxyCodeLine{00371\ \ \ \}}
\DoxyCodeLine{00372\ \ \ \mbox{\hyperlink{fdrs__debug_8h_adf135b87caf84f55fccdf33f614415ae}{DBG}}(\textcolor{stringliteral}{"{}No\ subscription\ to\ remove"{}});}
\DoxyCodeLine{00373\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00374\ \}}
\DoxyCodeLine{00375\ }
\DoxyCodeLine{00376\ }
\DoxyCodeLine{00377\ }
\DoxyCodeLine{00378\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{fdrs__node_8h_aadfe1d6cc1e61d0a4ef3f9cacdace6bd}{pingFDRS}}(uint32\_t\ timeout)}
\DoxyCodeLine{00379\ \{}
\DoxyCodeLine{00380\ \ \ \textcolor{keywordtype}{int}\ pingResult\ =\ -\/1;}
\DoxyCodeLine{00381\ \textcolor{preprocessor}{\#ifdef\ USE\_ESPNOW}}
\DoxyCodeLine{00382\ \ \ pingResult\ =\ \mbox{\hyperlink{fdrs__node__espnow_8h_aee659695219834430cec1b893bb1911e}{pingFDRSEspNow}}(\mbox{\hyperlink{fdrs__node_8h_a62994e4f9af5770586faddf3c4d2b084}{gatewayAddress}},\ timeout);}
\DoxyCodeLine{00383\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00384\ \textcolor{preprocessor}{\#ifdef\ USE\_LORA}}
\DoxyCodeLine{00385\ \ \ pingResult\ =\ \mbox{\hyperlink{fdrs__lora_8h_acb6e120ce92a8851fe1cb471da64409d}{pingRequestLoRa}}(gtwyAddress,\ timeout);}
\DoxyCodeLine{00386\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00387\ \ \ \textcolor{keywordflow}{return}\ pingResult;}
\DoxyCodeLine{00388\ \}}
\DoxyCodeLine{00389\ }
\DoxyCodeLine{00390\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{fdrs__node_8h_aa92d5c563ce3345406f36fe1e038fa29}{reqTimeFDRS}}()\ \{}
\DoxyCodeLine{00391\ \textcolor{preprocessor}{\#ifdef\ USE\_ESPNOW}}
\DoxyCodeLine{00392\ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{fdrs__node__espnow_8h_a88c653d6c1f329d097b4e3ed6df2831b}{reqTimeEspNow}}();}
\DoxyCodeLine{00393\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00394\ \textcolor{preprocessor}{\#ifdef\ USE\_LORA}}
\DoxyCodeLine{00395\ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{fdrs__node_8h_a1dbf8358f6b651f668b09459d6a43cd8}{reqTimeLoRa}}();}
\DoxyCodeLine{00396\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00397\ \}}
\DoxyCodeLine{00398\ }
\DoxyCodeLine{00399\ \textcolor{comment}{//\ Skeleton\ Functions\ related\ to\ function\ calls\ to\ files\ that\ are\ not\ included}}
\DoxyCodeLine{00400\ \textcolor{preprocessor}{\#ifndef\ USE\_LORA}}
\DoxyCodeLine{00401\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{fdrs__node_8h_a181e287094b776a5461ee501144b60de}{sendTimeLoRa}}()\ \{\}}
\DoxyCodeLine{00402\ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{fdrs__node_8h_a1dbf8358f6b651f668b09459d6a43cd8}{reqTimeLoRa}}()\ \{\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};\ \}}
\DoxyCodeLine{00403\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00404\ \textcolor{preprocessor}{\#ifndef\ USE\_ESPNOW}}
\DoxyCodeLine{00405\ \ \ \mbox{\hyperlink{fdrs__datatypes_8h_a8bc4f6626a2d4ebd67533c56064ccda8}{esp\_err\_t}}\ \mbox{\hyperlink{fdrs__node_8h_a4a3493bd7c048fd6a4d72800abf84549}{sendTimeESPNow}}()\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{fdrs__datatypes_8h_abdbffa06442bc1fe3d65dbb8d17656d1}{ESP\_OK}};\ \}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ fdrs\_gateway\_time.h}}
\DoxyCodeLine{00406\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00407\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{fdrs__node_8h_a34baf31b0b954403e1432d3cdb85a90d}{sendTimeSerial}}()\ \{\ \}}

\end{DoxyCode}
